<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::Layout(~{::section})}">
<head>
<meta charset="UTF-8">
<title>Add Course</title>



</head>
<body>
	<section class="container mt-4 py-4">

		<!-- Add / Edit Course Card -->
		<div class="card shadow-lg border-0 p-4 mb-4">
			<h4 class="mb-4">
				<i class="fa-solid fa-book text-primary"></i> [[${course.id == null
				? 'Add New Course' : 'Edit Course'}]]
			</h4>

			<form th:action="@{/admin/course/save}" th:object="${course}"
				method="post" enctype="multipart/form-data">

				<input type="hidden" th:field="*{id}">

				<div class="row g-4">

					<!-- Course Name -->
					<div class="col-md-6">
						<label class="form-label fw-bold">Course Name</label> <input
							type="text" class="form-control" th:field="*{name}" required>
					</div>

					<!-- Category -->
					<div class="col-md-6">
						<label class="form-label fw-bold">Category</label> <select
							class="form-select" th:field="*{categoryId}" required>
							<option value="">-- Select Category --</option>
							<option th:each="cat : ${categoryList}" th:value="${cat.id}"
								th:text="${cat.name}"></option>
						</select>
					</div>

					<!-- Teacher -->
					<div class="col-md-6">
						<label class="form-label fw-bold">Teacher</label> <select
							class="form-select" th:field="*{teacherId}" required>
							<option value="">-- Select Teacher --</option>
							<option th:each="t : ${teacherList}" th:value="${t.id}"
								th:text="${t.name}"></option>
						</select>
					</div>

					<!-- Price -->
					<div class="col-md-3">
						<label class="form-label fw-bold">Price</label> <input
							type="number" class="form-control" th:field="*{price}" required>
					</div>

					<!-- Discount -->
					<div class="col-md-3">
						<label class="form-label fw-bold">Max Discount (%)</label> <input
							type="number" class="form-control" th:field="*{discount}" min="0"
							max="100" required>
					</div>

					<!-- Description -->
					<div class="col-12">
						<label class="form-label fw-bold">Description</label>
						<textarea class="form-control" th:field="*{description}" rows="4"></textarea>
					</div>

					<!-- Tags -->
					<div class="col-md-6">
						<label class="form-label fw-bold">Search Tags</label> <input
							type="text" class="form-control" th:field="*{searchTags}" maxlength="100">
					</div>

					<!-- Logo Upload -->
					<!-- Logo Upload -->
					<div class="col-md-6">
						<label class="form-label fw-bold">Course Logo</label> <input
							type="file" class="form-control" name="logoFile" accept="image/*"
							onchange="previewLogo(event)">

						<!-- REAL Preview Image -->
						<img class="img-clickable" id="logoPreview" th:if="${course.logo != null}"
							th:src="@{'/course/' + ${course.logo}}"
							style="width: 100px; height: 100px; border-radius: 10px; object-fit: cover; margin-top: 10px; display: block;">
					</div>
					<!-- Active -->
					<div class="col-md-12 form-check mt-3">
						<input type="checkbox" class="form-check-input"
							th:field="*{isActive}"> <label
							class="form-check-label fw-bold">Active</label>
					</div>

					<!-- Save -->
					<div class="col-md-12 mt-3">
						<button type="submit" class="btn btn-primary w-100 py-2">
							<i class="fa-solid fa-check"></i> Save Course
						</button>
					</div>

				</div>
			</form>
		</div>

		<!-- Image Preview Modal -->
		<div class="modal fade" id="imagePreviewModal" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-body p-0">
						<img id="previewImage" src="" class="w-100"
							style="border-radius: 10px;">
					</div>
				</div>
			</div>
		</div>

		<!-- List of Courses -->
		<div class="card shadow border-0 p-4">
			<h4 class="mb-3">
				<i class="fa-solid fa-list text-primary"></i> All Courses
			</h4>

			<div th:if="${msg}" class="alert alert-success">[[${msg}]]</div>

			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th>ID</th>
						<th>Logo</th>
						<th>Name</th>
						<th>Category</th>
						<th>Teacher</th>
						<th>Price</th>
						<th>Discount</th>
						<th>Active</th>
						<th>Action</th>
					</tr>
				</thead>

				<tbody>
					<tr th:each="c : ${courses}">
						<td th:text="${c.id}"></td>

						<!-- Logo (clickable) -->
						<td><img th:src="${c.logo != null} ? @{'/course/'+${c.logo}}"
							class="img-clickable"
							style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
						</td>

						<td th:text="${c.name}"></td>
						<td th:text="${c.categoryName}"></td>
						<td th:text="${c.teacherName}"></td>
						<td>रु [[${c.price}]]</td>
						<td>[[${c.discount}]]%</td>

						<td><span class="badge bg-success" th:if="${c.isActive}">Active</span>
							<span class="badge bg-danger" th:if="${!c.isActive}">Disabled</span>
						</td>

						<td>
    <div class="btn-group" role="group" aria-label="Course Actions">
        
        <a th:href="@{/admin/course/edit(id=${c.id})}"
            class="btn btn-sm btn-primary"> 
            <i class="fa-solid fa-pen-to-square"></i> Edit 
        </a>
        
        <a th:href="@{'/admin/courses/videos/' + ${c.id}}"
            class="btn btn-sm btn-info"
            title="Manage videos associated with this course">
            <i class="fa-solid fa-video"></i> Videos 
        </a>
        
        <button class="btn btn-sm btn-danger delete-btn"
            th:data-id="${c.id}"
            title="Delete this course and associated data">
            <i class="fa-solid fa-trash"></i> Delete
        </button>
        
    </div>
</td>
					</tr>
				</tbody>
			</table>
<nav th:if="${totalPages > 1}" class="mt-4">
    <ul class="pagination justify-content-center">

        <!-- Previous -->
        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
            <a class="page-link"
               th:href="@{/admin/course/add(page=${currentPage - 1})}">
                Previous
            </a>
        </li>

        <!-- Page numbers -->
        <li class="page-item"
            th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
            th:classappend="${currentPage == i} ? 'active'">
            <a class="page-link"
               th:href="@{/admin/course/add(page=${i})}"
               th:text="${i + 1}">
            </a>
        </li>

        <!-- Next -->
        <li class="page-item"
            th:classappend="${currentPage + 1 == totalPages} ? 'disabled'">
            <a class="page-link"
               th:href="@{/admin/course/add(page=${currentPage + 1})}">
                Next
            </a>
        </li>

    </ul>
</nav>

		</div>


<script>
document.addEventListener("DOMContentLoaded", () => {

    // Delete buttons
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            if (confirm("Are you sure you want to delete this course?")) {
                window.location.href = "/admin/course/delete?id=" + id;
            }
        });
    });

    // Image modal for table thumbnails
    document.querySelectorAll(".img-clickable").forEach(img => {
        img.addEventListener("click", () => {
            const src = img.getAttribute('src');
            if (!src) return;
            document.getElementById("previewImage").src = src;
            const modal = new bootstrap.Modal(document.getElementById("imagePreviewModal"));
            modal.show();
        });
    });

    // Preview logo on upload
    const fileInput = document.querySelector("input[name='logoFile']");
    if (fileInput) {
        fileInput.addEventListener("change", event => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function() {
                const output = document.getElementById('logoPreview');
                if (!output) return;
                output.src = reader.result;
                output.style.display = 'block';
            }
            reader.readAsDataURL(file);
        });
    }

});
</script>

	</section>
</body>
</html>