<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::Layout(~{::section})}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<section class="container mt-5 pt-4">

    <div class="card shadow-lg border-0 p-4">
        <h4 class="mb-3">
            <i class="fa-solid fa-user-shield text-primary"></i>
            User Promotion Panel
        </h4>

        <!-- Search Box -->
        <div class="input-group mb-3">
            <input id="searchInput" type="text" class="form-control"
                   placeholder="Search by Phone or Email">
            <button class="btn btn-primary" id="searchBtn">
                <i class="fa fa-search"></i>
            </button>
        </div>
<div id="notification" class="alert d-none" role="alert"></div>

        <!-- Result Box -->
        <div id="resultBox" class="d-none">

            <div class="alert alert-success" id="userInfo"></div>

            <h5>Change User Role</h5>

            <div class="btn-group mt-2">
                <button class="btn btn-outline-primary role-btn" data-role="ROLE_TEACHER">
                    Make Teacher
                </button>
                <button class="btn btn-outline-success role-btn" data-role="ROLE_AFFILIATE">
                    Make Affiliate
                </button>
                <button class="btn btn-outline-secondary role-btn" data-role="ROLE_USER">
                    Make Normal User
                </button>
            </div>

        </div>

    </div>



<script>
function showNotification(message, type = 'success') {
    const notif = document.getElementById("notification");
    notif.className = `alert alert-${type} mt-2`; // type: success, danger, warning, info
    notif.innerText = message;
    notif.classList.remove("d-none");

    // Auto-hide after 3 seconds
    setTimeout(() => {
        notif.classList.add("d-none");
    }, 3000);
}

document.getElementById("searchBtn").addEventListener("click", async () => {
    let raw = document.getElementById("searchInput").value.trim();
    let q = encodeURIComponent(raw);
    if (!q) return;

    try {
        let res = await axios.get(`/admin/search?query=${q}`);
        let user = res.data;

        document.getElementById("resultBox").classList.remove("d-none");
        document.getElementById("userInfo").innerHTML =
                `<b>Name:</b> ${user.name}<br>
                 <b>Email:</b> ${user.emailId}<br>
                 <b>Phone:</b> ${user.phoneNumber}<br>
                 <b>Current Role:</b> <span class="text-primary">${user.role}</span>`;

        document.querySelectorAll(".role-btn").forEach(btn => {
            btn.onclick = async () => {
                try {
                    let updateRes = await axios.post("/admin/update-role", null, {
                        params: { id: user.id, role: btn.dataset.role }
                    });

                    if (updateRes.data === "ooo Admin is immortal") {
                        showNotification("Admin role cannot be changed!", "warning");
                    } else {
                        showNotification("Role Updated Successfully!", "success");
                        document.getElementById("searchBtn").click(); // Refresh UI
                    }

                } catch (err) {
                    showNotification("Something went wrong!", "danger");
                }
            };
        });

    } catch (e) {
        showNotification("User not found!", "danger");
    }
});
</script>

</section>
</body>
</html>