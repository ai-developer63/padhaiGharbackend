<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base::Layout(~{::section})}">
<head>
<meta charset="UTF-8">
<title>Banner Management</title>
</head>
<body>
<section class="container mt-5 pt-4">

    <div class="card shadow-lg border-0 p-4 mb-4">
        <h4 class="mb-3">
            <i class="fa-solid fa-images text-primary"></i>
            Add / Edit Banner
        </h4>

        <div id="notification" class="alert d-none" role="alert"></div>

        <form id="bannerForm" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Banner Name</label>
                <input type="text" name="name" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Course</label>
                <select name="courseId" class="form-control" required>
                    <option th:each="c : ${courses}" th:value="${c.id}" th:text="${c.name}"></option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Banner Image</label>
                <input type="file" name="bannerFile" class="form-control" required>
            </div>
            <div class="col-md-2 form-check pt-3">
                <input type="checkbox" name="isVisible" class="form-check-input" checked>
                <label class="form-check-label">Visible</label>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-success w-100">Save</button>
            </div>
        </form>
    </div>
    
    <!-- Image View Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body text-center p-0">
        <img id="modalImage" src="" alt="Banner" class="img-fluid">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
    

    <div class="card shadow-lg border-0 p-4">
        <h4 class="mb-3">
            <i class="fa-solid fa-list text-primary"></i>
            Banner List
        </h4>

        <table class="table table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Course</th>
                    <th>Image</th>
                    <th>Visible</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="bannerTable">
                <tr th:each="banner : ${banners}" th:data-id="${banner.id}">
                    <td th:text="${banner.id}"></td>
                    <td th:text="${banner.name}"></td>
                    <td th:text="${banner.courseName}"></td>
                 <td>
    <img th:src="@{'/banner/' + ${banner.banner}}" 
         alt="Banner Image" 
         class="img-thumbnail banner-thumb" 
         style="width:100px; cursor:pointer;">
</td>
                    <td>
                        <input type="checkbox" class="toggle-visibility" th:checked="${banner.isVisible}">
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm delete-banner">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        <nav aria-label="Page navigation">
    <ul class="pagination mt-3">
        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
            <a class="page-link" th:href="@{/admin/manage(page=${currentPage - 1})}">Previous</a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'">
            <a class="page-link" th:href="@{/admin/manage(page=${i})}" th:text="${i + 1}"></a>
        </li>
        <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
            <a class="page-link" th:href="@{/admin/manage(page=${currentPage + 1})}">Next</a>
        </li>
    </ul>
</nav>
        
    </div>

<script>
function showNotification(message, type='success') {
    const notif = document.getElementById("notification");
    notif.className = `alert alert-${type} mt-2`;
    notif.innerText = message;
    notif.classList.remove("d-none");
    setTimeout(() => notif.classList.add("d-none"), 3000);
}

//popup of images
document.getElementById("bannerTable").addEventListener("click", (e) => {
    if (e.target.classList.contains("banner-thumb")) {
        const src = e.target.getAttribute("src");
        const modalImg = document.getElementById("modalImage");
        modalImg.src = src;

        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
        imageModal.show();
    }
});


// Form submit
document.getElementById("bannerForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    try {
        const res = await axios.post("/admin/banner/save", formData, { headers: { 'Content-Type': 'multipart/form-data' } });
        const table = document.getElementById("bannerTable");
        table.insertAdjacentHTML("beforeend", `
            <tr data-id="${res.data.id}">
                <td>${res.data.id}</td>
                <td>${res.data.name}</td>
                <td>${res.data.courseName}</td>
                <td>${res.data.banner}</td>
                <td><input type="checkbox" class="toggle-visibility" ${res.data.isVisible ? 'checked':''}></td>
                <td>
                    <button class="btn btn-danger btn-sm delete-banner"><i class="fa fa-trash"></i></button>
                </td>
            </tr>
        `);
        form.reset();
        showNotification("Banner added!");
    } catch {
        showNotification("Failed to save banner", "danger");
    }
});

// Delegate event listeners for dynamically added rows
document.getElementById("bannerTable").addEventListener("change", async (e) => {
    if(e.target.classList.contains("toggle-visibility")) {
        const row = e.target.closest("tr");
        const id = row.dataset.id;
        try {
            await axios.post("/admin/banner/toggle", null, { params: { id } });
            showNotification("Visibility updated!");
        } catch {
            showNotification("Failed to update visibility", "danger");
        }
    }
});

document.getElementById("bannerTable").addEventListener("click", async (e) => {
    if(e.target.closest(".delete-banner")) {
        const row = e.target.closest("tr");
        const id = row.dataset.id;

        // Ask for confirmation
        const confirmed = confirm("Are you sure you want to delete this banner?");
        if (!confirmed) return; // Cancel if user clicks "Cancel"

        try {
            await axios.post("/admin/banner/delete", null, { params: { id } });
            row.remove();
            showNotification("Banner deleted!");
        } catch {
            showNotification("Failed to delete banner", "danger");
        }
    }
});

</script>
</section>
</body>
</html>
